<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>SMURD RezervƒÉri - Control Total</title>
  
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

  <style>
    :root { --primary: #2563eb; --danger: #ef4444; --success: #22c55e; --warning: #f59e0b; --gray: #64748b; --bg: #f8fafc; }
    body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); margin: 0; padding: 10px; color: #1e293b; }
    .container { max-width: 1000px; margin: auto; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    
    .grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
    @media (min-width: 768px) { .grid { grid-template-columns: 1.2fr 1fr; } body { padding: 20px; } }

    /* Calendar & Slots */
    .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 10px; }
    .calendar button { aspect-ratio: 1/1; border-radius: 8px; border: 1px solid #e2e8f0; background: white; font-weight: 600; cursor: pointer; }
    .day-free { background: #ecfdf5 !important; color: #059669; }
    .day-full { background: #f1f5f9 !important; color: #94a3b8; cursor: not-allowed; text-decoration: line-through; }
    .calendar button.selected { background: var(--primary) !important; color: white !important; }

    .time-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(75px, 1fr)); gap: 10px; margin-top: 10px; max-height: 250px; overflow-y: auto; padding: 5px; border: 1px solid #eee; border-radius: 8px; }
    .time-slot { padding: 12px 5px; border: 1px solid #e2e8f0; border-radius: 10px; text-align: center; font-size: 14px; font-weight: 600; background: #fff; cursor: pointer; }
    .time-slot.active { background: var(--primary); color: white; }
    .time-slot.taken { background: #fee2e2; color: #ef4444; text-decoration: line-through; }

    input, select { width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e2e8f0; margin-bottom: 10px; box-sizing: border-box; font-size: 16px; }
    .confirm-btn { width: 100%; padding: 15px; background: var(--success); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; }
    
    /* System Lock Overlay */
    .system-lock-msg { display: none; background: #fff7ed; border: 1px solid #fdba74; color: #c2410c; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-weight: bold; text-align: center; }

    .locked { opacity: 0.3; pointer-events: none; transition: 0.3s; }
    .unlocked { opacity: 1 !important; pointer-events: auto !important; }

    .admin-panel { margin-top: 30px; padding-top: 20px; border-top: 3px double #e2e8f0; display: none; }
    .admin-section { background: #f8fafc; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #cbd5e1; }
    
    .vol-list-container { max-height: 200px; overflow-y: auto; background: white; border: 1px solid #e2e8f0; border-radius: 8px; margin-top: 10px; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th, td { padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: left; }
    th { background: #f1f5f9; position: sticky; top: 0; }
    .ts-label { font-size: 10px; color: var(--gray); display: block; }
    .manual-tag { font-size: 10px; background: #fee2e2; color: #ef4444; padding: 2px 5px; border-radius: 4px; font-weight: bold; }

    /* Admin Toggle Switch */
    .switch { position: relative; display: inline-block; width: 60px; height: 30px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--success); transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--danger); }
    input:checked + .slider:before { transform: translateX(30px); }

    @media print { .no-print { display: none !important; } .admin-panel { display: block !important; } }
  </style>
</head>
<body>

<div class="container">
  <div class="no-print" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
    <h2 style="margin:0; color:var(--danger)">SMURD RezervƒÉri</h2>
    <button id="adminLoginBtn" onclick="adminLogin()">üîë Admin Login</button>
  </div>

  <div id="maintenanceMsg" class="system-lock-msg">
    ‚ö†Ô∏è REZERVƒÇRI BLOCATE: Sistemul este √Æn mentenan»õƒÉ.
  </div>

  <div class="grid no-print">
    <div>
      <div id="authBox" style="background: #eff6ff; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
        <label style="font-size: 11px; font-weight: bold; color: var(--primary);">ACCES VOLUNTAR:</label>
        <input type="text" id="phoneAuth" placeholder="Introduce»õi NumƒÉrul de Telefon" oninput="verifyPhone()">
        <div id="authMessage" style="font-size: 13px; font-weight: bold; margin-bottom: 5px;"></div>
      </div>

      <div id="nameInputBox">
        <label style="font-size: 11px; font-weight: bold; color: var(--gray);">NUME VOLUNTAR:</label>
        <input type="text" id="userName" placeholder="Nume (Automat)" readonly style="background: #f1f5f9;">
      </div>

      <div id="bookingControls" class="locked">
        <div id="selectedDateLabel" style="font-weight:bold; color:var(--primary); margin-bottom:10px;">Alege o zi...</div>
        <div class="time-grid" id="timeGrid"></div>
        <button id="mainConfirmBtn" class="confirm-btn" onclick="confirmBooking()" style="margin-top:15px;" disabled>ConfirmƒÉ Rezervarea</button>
      </div>
    </div>

    <div id="calendarContainer" class="locked">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <button onclick="changeMonth(-1)">¬´</button>
        <strong id="monthLabel"></strong>
        <button onclick="changeMonth(1)">¬ª</button>
      </div>
      <div class="calendar" id="calendar"></div>
    </div>
  </div>

  <div class="admin-panel" id="adminView">
    <div class="no-print" style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 15px; background: #fff1f2; padding: 15px; border-radius: 10px; border: 1px solid #fecaca;">
      <div>
        <h3 style="color:var(--danger); margin:0;">üîê CONTROL ADMIN</h3>
        <p style="margin:5px 0 0 0; font-size:12px;">ModificƒÉri manuale »ôi setƒÉri sistem</p>
      </div>
      
      <div style="text-align: right;">
        <label style="font-size: 12px; font-weight: bold; display: block; margin-bottom: 5px;">BLOCARE REZERVƒÇRI:</label>
        <label class="switch">
          <input type="checkbox" id="systemLockToggle" onchange="toggleSystemLock(this.checked)">
          <span class="slider"></span>
        </label>
      </div>
    </div>
    
    <div class="admin-section no-print">
        <h4 style="margin-top:0;">üë• ListƒÉ Voluntari Autoriza»õi (Whitelist)</h4>
        <div style="display:flex; gap:10px; flex-wrap: wrap;">
          <input type="text" id="newVolName" placeholder="Nume Complet" style="flex:1;">
          <input type="text" id="newVolPhone" placeholder="Telefon" style="flex:1;">
          <button onclick="addVolunteer()" class="confirm-btn" style="background:var(--primary); width: auto; padding: 0 20px;">AdaugƒÉ Voluntar</button>
        </div>
        <div class="vol-list-container">
            <table>
                <thead><tr><th>Nume Voluntar</th><th>Telefon</th><th style="text-align:right;">Ac»õiune</th></tr></thead>
                <tbody id="volunteersList"></tbody>
            </table>
        </div>
    </div>

    <div class="admin-section">
      <div style="display:flex; justify-content:space-between;">
        <h4 class="no-print">üìÖ Tabel RezervƒÉri Active</h4>
        <button class="no-print" onclick="window.print()" style="background:var(--gray); color:white; border:none; padding:5px 15px; border-radius:5px; cursor:pointer;">üñ®Ô∏è Print</button>
      </div>
      <div style="overflow-x:auto;">
        <table>
          <thead>
            <tr><th>Voluntar</th><th>Data / Interval</th><th>√énregistrat la</th><th class="no-print">EliminƒÉ</th></tr>
          </thead>
          <tbody id="adminTable"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  // CONFIGURARE FIREBASE
const firebaseConfig = {
  apiKey: "AIzaSyDlpy92yTmFVzrvF5sGfT50pEipMx3k2Pg",
  authDomain: "rezervari-smurd.firebaseapp.com",
  databaseURL: "https://rezervari-smurd-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "rezervari-smurd",
  storageBucket: "rezervari-smurd.firebasestorage.app",
  messagingSenderId: "694856921809",
  appId: "1:694856921809:web:de6e004fd6a9cd5f4c0bf0",
  measurementId: "G-9J65W91YHD"
};

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const START_H = 8, END_H = 22, ADMIN_PASS = "admin1234*";
  let curDate = new Date(), selDate = null, selStart = null, selEnd = null;
  let bookings = [], volunteers = [], isAdmin = false, isSystemLocked = false;
  const slots = [];
  for(let i=START_H; i<=END_H; i++) slots.push(`${String(i).padStart(2,'0')}:00`);

  // Sync: Stare Blocare Sistem
  db.ref('settings/isLocked').on('value', snap => {
    isSystemLocked = snap.val() || false;
    document.getElementById("systemLockToggle").checked = isSystemLocked;
    updateMaintenanceUI();
  });

  db.ref('volunteers').on('value', snap => {
    const val = snap.val();
    volunteers = val ? Object.keys(val).map(key => ({id: key, ...val[key]})) : [];
    renderVolunteersList();
  });

  db.ref('bookings').on('value', snap => {
    bookings = snap.val() ? Object.values(snap.val()) : [];
    renderCalendar();
    renderAdmin();
  });

  function updateMaintenanceUI() {
    const msg = document.getElementById("maintenanceMsg");
    if(isSystemLocked) {
        msg.style.display = "block";
        if(!isAdmin) {
            document.getElementById("bookingControls").classList.remove("unlocked");
            document.getElementById("calendarContainer").classList.remove("unlocked");
        }
    } else {
        msg.style.display = "none";
        if(!isAdmin) verifyPhone(); // Re-verificƒÉ accesul dacƒÉ era deja logat
    }
  }

  function toggleSystemLock(state) {
    db.ref('settings/isLocked').set(state);
  }

  function adminLogin() {
    const pass = prompt("Parola administrator:");
    if(pass === ADMIN_PASS) {
        isAdmin = true;
        document.getElementById("adminView").style.display = "block";
        document.getElementById("adminLoginBtn").innerText = "‚úÖ Admin Mod";
        document.getElementById("bookingControls").classList.add("unlocked");
        document.getElementById("calendarContainer").classList.add("unlocked");
        document.getElementById("authBox").style.display = "none";
        const nameInp = document.getElementById("userName");
        nameInp.readOnly = false; nameInp.style.background = "#fff";
        nameInp.placeholder = "Scrie numele manual..."; nameInp.value = "";
    } else { alert("ParolƒÉ incorectƒÉ."); }
  }

  function verifyPhone() {
    if(isAdmin) return;
    if(isSystemLocked) {
        document.getElementById("authMessage").innerText = "‚ö†Ô∏è Mentenan»õƒÉ √Æn curs...";
        document.getElementById("authMessage").style.color = "orange";
        return;
    }
    const phone = document.getElementById("phoneAuth").value.trim();
    const found = volunteers.find(v => v.phone === phone);
    const msg = document.getElementById("authMessage");
    if(found) {
        document.getElementById("bookingControls").classList.add("unlocked");
        document.getElementById("calendarContainer").classList.add("unlocked");
        msg.innerText = "‚úÖ Identificat: " + found.name; msg.style.color = "green";
        document.getElementById("userName").value = found.name;
    } else {
        document.getElementById("bookingControls").classList.remove("unlocked");
        document.getElementById("calendarContainer").classList.remove("unlocked");
        msg.innerText = "‚ùå NumƒÉr neautorizat!"; msg.style.color = "red";
        document.getElementById("userName").value = "";
    }
  }

  function confirmBooking() {
    if(isSystemLocked && !isAdmin) return alert("Sistemul este blocat pentru mentenan»õƒÉ!");
    
    const name = document.getElementById("userName").value.trim();
    const phone = isAdmin ? "MANUAL_ADMIN" : document.getElementById("phoneAuth").value;
    if(!name || !selDate || selStart === null || selEnd === null) return alert("Date incomplete!");
    
    if(!isAdmin) {
        const count = bookings.filter(b => b.phone === phone && new Date(b.date).getMonth() === selDate.getMonth()).length;
        if(count >= 2) return alert("Ai atins limita de 2 rezervƒÉri pe lunƒÉ!");
    }
    
    const id = Date.now();
    db.ref('bookings/'+id).set({
      id, name, phone, date: selDate.toISOString(),
      start: slots[selStart], end: slots[selEnd],
      createdAt: new Date().toLocaleString('ro-RO')
    });
    alert("Rezervare confirmatƒÉ!");
    if(isAdmin) document.getElementById("userName").value = "";
    selStart = null; selEnd = null; renderTimeSlots();
  }

  function renderAdmin() {
    const t = document.getElementById("adminTable"); t.innerHTML = "";
    [...bookings].sort((a,b) => new Date(a.date) - new Date(b.date))
      .filter(b => new Date(b.date).getMonth() === curDate.getMonth())
      .forEach(b => {
        const phoneLabel = (b.phone === "MANUAL_ADMIN") ? `<br><span class="manual-tag">MANUAL_ADMIN</span>` : "";
        t.innerHTML += `<tr>
          <td><strong>${b.name}</strong>${phoneLabel}</td>
          <td>${new Date(b.date).toLocaleDateString('ro-RO')}<br>${b.start} - ${b.end}</td>
          <td><span class="ts-label">${b.createdAt || 'N/A'}</span></td>
          <td class="no-print"><button onclick="deleteBooking(${b.id})" style="color:red; background:none; border:none; cursor:pointer;">‚ùå</button></td>
        </tr>`;
      });
  }

  function addVolunteer() {
    const name = document.getElementById("newVolName").value.trim();
    const phone = document.getElementById("newVolPhone").value.trim();
    if(!name || !phone) return alert("CompleteazƒÉ ambele c√¢mpuri!");
    db.ref('volunteers').push({ name, phone });
    document.getElementById("newVolName").value = ""; document.getElementById("newVolPhone").value = "";
  }

  function renderVolunteersList() {
    const list = document.getElementById("volunteersList"); list.innerHTML = "";
    volunteers.forEach(v => {
        list.innerHTML += `<tr><td><strong>${v.name}</strong></td><td>${v.phone}</td><td style="text-align:right;"><button onclick="deleteVolunteer('${v.id}')" style="color:red; background:none; border:none; cursor:pointer;">‚ùå »òterge</button></td></tr>`;
    });
  }

  function deleteVolunteer(id) { if(confirm("Elimini voluntarul?")) db.ref('volunteers/' + id).remove(); }
  function deleteBooking(id) { if(confirm("»òtergi rezervarea?")) db.ref('bookings/'+id).remove(); }
  function isDayFull(d) {
    const dayB = bookings.filter(b => new Date(b.date).toDateString() === d.toDateString());
    if (dayB.length === 0) return false;
    for(let i=0; i<slots.length-1; i++) { if(!dayB.some(b => slots[i] >= b.start && slots[i] < b.end)) return false; }
    return true;
  }

  function renderCalendar() {
    const cal = document.getElementById("calendar"); cal.innerHTML = "";
    document.getElementById("monthLabel").innerText = curDate.toLocaleString('ro-RO',{month:'long',year:'numeric'});
    const y = curDate.getFullYear(), m = curDate.getMonth(), lastDay = new Date(y, m+1, 0).getDate();
    for(let i=1; i<=lastDay; i++) {
      const d = new Date(y, m, i);
      const btn = document.createElement("button"); btn.innerText = i;
      if(isDayFull(d)) btn.className = "day-full";
      else {
        btn.className = "day-free";
        btn.onclick = () => {
          selDate = new Date(y, m, i); selStart = null; selEnd = null;
          document.getElementById("selectedDateLabel").innerText = "Data: " + selDate.toLocaleDateString('ro-RO');
          renderCalendar(); renderTimeSlots();
        };
      }
      if(selDate && d.toDateString() === selDate.toDateString()) btn.classList.add("selected");
      cal.appendChild(btn);
    }
  }

  function renderTimeSlots() {
    const grid = document.getElementById("timeGrid"); grid.innerHTML = "";
    if(!selDate) return;
    const dayB = bookings.filter(b => new Date(b.date).toDateString() === selDate.toDateString());
    slots.forEach((s, i) => {
      const div = document.createElement("div"); div.className = "time-slot"; div.innerText = s;
      if(dayB.some(b => s >= b.start && s < b.end)) div.classList.add("taken");
      else {
        div.onclick = () => {
          if(selStart === null || (selStart !== null && selEnd !== null)) { selStart = i; selEnd = null; }
          else { if(i < selStart) { selEnd = selStart; selStart = i; } else { selEnd = i; } }
          renderTimeSlots();
          document.getElementById("mainConfirmBtn").disabled = (selStart === null || selEnd === null);
        };
        if(selStart === i || selEnd === i) div.classList.add("active");
        if(selStart !== null && selEnd !== null && i > selStart && i < selEnd) div.classList.add("in-range");
      }
      grid.appendChild(div);
    });
  }

  function changeMonth(off) { curDate.setMonth(curDate.getMonth() + off); renderCalendar(); renderAdmin(); }
  renderCalendar();
</script>
</body>
</html>
